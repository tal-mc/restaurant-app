# =============================================================================
# CD.YML - Continuous Deployment
# =============================================================================
# Runs on: Push to main branch, Manual trigger
# Purpose: Build, push, and deploy to Azure
#
# FLOW:
# 1. Build Docker image with commit SHA tag
# 2. Push to GitHub Container Registry (GHCR)
# 3. Run Terraform to update Azure Container Instance
# 4. Run smoke tests to verify deployment
#
# IMPORTANT: Terraform is IDEMPOTENT
# - If only app code changed ‚Üí Only container image updates
# - If only terraform changed ‚Üí Only infrastructure updates
# - If nothing changed ‚Üí No action taken
# =============================================================================

name: CD - Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger from GitHub UI
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

# Only one deployment at a time
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel in-progress deployments

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TF_VAR_environment: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  # ---------------------------------------------------------------------------
  # JOB 1: Build and Push Docker Image
  # ---------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      full_image: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Use commit SHA as primary tag (for traceability)
            type=sha,prefix=
            # Also tag as 'latest' for convenience
            type=raw,value=latest
            # Include branch name
            type=ref,event=branch
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image info
        run: |
          echo "üì¶ Image pushed to: ${{ steps.meta.outputs.tags }}"
          echo "üè∑Ô∏è  Version: ${{ steps.meta.outputs.version }}"

  # ---------------------------------------------------------------------------
  # JOB 2: Deploy Infrastructure with Terraform
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: [build-and-push]
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    outputs:
      api_url: ${{ steps.outputs.outputs.api_url }}
      health_endpoint: ${{ steps.outputs.outputs.health_endpoint }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false  # Needed for output parsing
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set Terraform Backend Access Key
        run: echo "ARM_ACCESS_KEY=${{ secrets.TF_BACKEND_ACCESS_KEY }}" >> $GITHUB_ENV
      
      - name: Terraform Init
        working-directory: terraform
        run: terraform init
      
      - name: Terraform Plan
        working-directory: terraform
        run: |
          terraform plan \
            -var="docker_image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}" \
            -var="mongodb_uri=${{ secrets.MONGODB_URI }}" \
            -var="environment=${{ env.TF_VAR_environment }}" \
            -out=tfplan
        env:
          ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      
      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve tfplan
        env:
          ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      
      - name: Get Terraform Outputs
        id: outputs
        working-directory: terraform
        run: |
          echo "api_url=$(terraform output -raw api_url)" >> $GITHUB_OUTPUT
          echo "health_endpoint=$(terraform output -raw health_endpoint)" >> $GITHUB_OUTPUT
          echo "rest_endpoint=$(terraform output -raw rest_endpoint)" >> $GITHUB_OUTPUT
          
          echo "üöÄ Deployment complete!"
          echo "üìç API URL: $(terraform output -raw api_url)"
          echo "‚ù§Ô∏è  Health: $(terraform output -raw health_endpoint)"

  # ---------------------------------------------------------------------------
  # JOB 3: Smoke Tests
  # ---------------------------------------------------------------------------
  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy]
    
    steps:
      - name: Wait for container startup
        run: |
          echo "‚è≥ Waiting 60 seconds for container to start..."
          sleep 60
      
      - name: Test health endpoint
        run: |
          echo "üè• Testing health endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.deploy.outputs.health_endpoint }}")
          if [ "$response" != "200" ]; then
            echo "‚ùå Health check failed with status: $response"
            curl -s "${{ needs.deploy.outputs.health_endpoint }}" || true
            exit 1
          fi
          echo "‚úÖ Health check passed"
          curl -s "${{ needs.deploy.outputs.health_endpoint }}" | jq .
      
      - name: Test REST endpoint
        run: |
          echo "üçù Testing REST endpoint..."
          response=$(curl -s "${{ needs.deploy.outputs.api_url }}/rest?query=italian")
          echo "$response" | jq .
          
          # Verify response has expected structure
          if echo "$response" | jq -e '.restaurantRecommendation' > /dev/null; then
            echo "‚úÖ REST endpoint working"
          else
            echo "‚ùå Unexpected response format"
            exit 1
          fi
      
      - name: Test vegetarian query
        run: |
          echo "ü•ó Testing vegetarian query..."
          response=$(curl -s "${{ needs.deploy.outputs.api_url }}/rest?query=vegetarian%20italian")
          echo "$response" | jq .
          echo "‚úÖ Vegetarian query working"
      
      - name: Deployment Summary
        run: |
          echo "============================================"
          echo "üéâ DEPLOYMENT SUCCESSFUL"
          echo "============================================"
          echo "API URL: ${{ needs.deploy.outputs.api_url }}"
          echo "Health:  ${{ needs.deploy.outputs.health_endpoint }}"
          echo "Image:   ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}"
          echo "============================================"